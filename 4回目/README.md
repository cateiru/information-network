# 4回目 Internet Protocol IP

- NW: ネットワーク

## IP

OSI参照モデルのネットワーク層にあたる。

- 異なるNWへのデータ転送を実現
  - データリンク層は同じNWのホスト同士のみの通信
- ルーティング（経路制御）という機能
- ルータ（ゲートウェイ）という装置で実現

- IPパケット
  - 配送途中で紛失する可能性がある
  - 送信する順番と受信する順番が、異なる場合がある
- IPアドレス
  - データリンク層では
    - MACアドレス: 同一リンク内の端末を識別する
  - ネットワーク層では
    - IPアドレス: 接続されているNWすべての中から端末を識別する
    - 「すべてのホスト、ルータ（のネットワークインタフェース）はIPアドレスを持つ」

## IPアドレス（IPv4）

- 32bit整数
- 各ホストに割当
  - 「ネットワーク部」と「ホスト部」に分けられる

### ネットワーク部

- **データリンクのセグメントごと**に値が割り当てられ、他のセグメントと重ならないようにする。
- **同一データリンク**では**同一のネットワーク部**を持つ（同一LAN内では同じNW部）組織ごとに割り当てられている。

ルータでの転送で、宛先アドレスのネットワーク部を見て経路を決定する; 宛先端末のセグメントがわかる

### ホスト部

- 同一データリンク内で重ならないような値の割当組織内で自由に割り当てられる

### 分割方法

- 初期のIP: **クラスによる分割が決まる**
  - クラスフルアドレス機構, classful addressing
- 現在のIP: **サブネットマスクにより決まる**
  - クラスレスアドレス機構, classless addressing

#### クラスフルアドレス機構

- 特徴
  - 自己識別
  - 境界を計算
  - 効率的な経路検索 ネットワークアドレスを計算→ルーティング

- 第1オクテット
  - クラスA 1~127
  - クラスB 128~191
  - クラスC 192~223

### ネットワークアドレス

- ホスト部がすべて`0`→ NW（データリンクのセグメント）を表す
- IPアドレスでNWを表現

### （指定）ブロードキャストアドレス

- ホスト部がすべて`1` → NW上のすべてのホストを表す
- ブロードキャスト用

### リミテッドブロードキャストアドレス

- すべて`1`のアドレス
- ローカルNWでのブロードキャスト
- 自分のIPアドレス、NWプレフィックスを知るために用いる

### デフォルトルートアドレス

- IPアドレス、サブネットマスクがすべて0
- 「すべてのネットワーク」表す
- 「0.0.0.0/0」

### ループバックアドレス

- 127.any
  - 127 = (0111 1111)なのでclass A
- ローカルな計算機上のプロセス間通信で使用。自己診断用

### プライベートIPアドレス

構築したネットワークがインターネットと接続しない場合、外部と通信しない場合は、構築したネットワークでプライベートIPアドレスを利用できる。

- 10.0.0.0 ~ 10.255.255.255(10/8)
- 172.16.0.0 ~ 172.31.255.255(172.16/12)
- 192.168.0.0 ~ 192.168.255.255(192.168/16)

## IPデータグラムの経路制御

RFC1009 Requirements for Internet gateways (HISTORIC)
← obsolute
← RFC 1812 Requirements for IP Version 4 Routers (proposed standard)

### 経路制御の概要

IPデータグラムの宛先IPアドレスのNW部を経路表と比較し、直接配送が可能か、間接配送が必要か判断

- 直接配送
  - 宛先マシンが物理NWを共有
  - 宛先マシンに直接配送
    - 終点IPアドレス→物理アドレスに変換→物理アドレス宛のフレーム作成
- 間接配送
  - 宛先マシンが物理NWを共有していない
  - （ネクストホップ）ルータに転送
    - ルータIPアドレス→物理アドレスに変換→物理アドレス宛のフレーム作成

### テーブル駆動式IP経路制御

- Internet経路表（internet routing table)
  - 記憶容量小
  - 最小限の情報で経路制御
- IPでは
  - 同一物理NWのマシン→IPアドレスは共有のNW部をもつ
  - NW部で経路制御
  - 経路表は完全なIP経路制御アドレスをもつ必要はない

### ネクストホップによる経路制御（next hop routing)

- 経路表のエントリ（N, R）
  - N: NWのIPアドレス
  - R: Nへの経路上のルータ（ネクストホップ）のIPアドレス
    - Rのルータは直接配送可能（同一NW）でなければらない

### 経路表の特別なエントリ

- デフォルト経路
  - 経路表に宛先NWがない→デフォルトルータに送る
- ホスト指定経路
  - NWアドレスではなく、ホストと直接指定

---

クラスフルアドレス機構では、

- ひとつの物理NW ⇔ ひとつのNW部
  - 各物理NWに暮らすA, B, Cのアドレスブロックを対応
- 経路制御の判断。終点アドレスのNWにより
- 主要クラスA, B IPアドレスの枯渇
  - クラスCは相対的に余っていた

## サブネット経路制御アルゴリズム

- 従来の経路表 (NW address, next hop address)
  - クラスA, B, Cは、IPアドレスでNW部とホスト部を分割
  - IPアドレスのNW部をNW addressと比較
- サブネットの場合の経路表
  - 宛先IPアドレスと(subnet mask)のビット毎論理積を計算
  - 計算結果をNW addressと比較

### サブネット経路制御と失敗例

- あるある失敗例: 遠隔地のネットワークとは通信できても、近隣のネットワークとの通信に失敗
